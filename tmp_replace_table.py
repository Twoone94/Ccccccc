# -*- coding: utf-8 -*-
from pathlib import Path
start_marker = "      {/* 琛ㄦ牸鍖哄煙 */}"
overlay_block = "        <div className=\"absolute right-[12px] top-[8px] brand-body-xs nums-tabular text-secondary\">{scrollIndex} / {projectData.items.length || 1}</div>\n        </div>\n      </div>"
path = Path('src/pages/ProjectInterface.tsx')
text = path.read_text(encoding='utf-8')
start = text.find(start_marker)
if start == -1:
    raise SystemExit('start marker not found')
overlay_idx = text.find(overlay_block, start)
if overlay_idx == -1:
    raise SystemExit('overlay block not found')
end = overlay_idx + len(overlay_block)
new_block = """      {/* 琛ㄦ牸鍖哄煙 */}
      <div ref={tableRef} className=\"overflow-auto scroll-smooth relative bg-app no-scrollbar overscroll-contain\" style={tableHeight ? { height: tableHeight } : undefined} onScroll={computeScroll} onWheel={(e) => {\n        const target = e.target as HTMLElement;\n        if (target && target.closest('[data-vsel]')) return;\n        smartWheel(tableRef.current, e);\n        computeScroll();\n      }}>\n        <div className=\"min-w-[1440px] px-4 pb-8 space-y-3\">\n          <div className=\"sticky top-0 z-10\">\n            <div className={\`${tableGrid} rounded-2xl border border-app bg-app/95 px-4 py-2 text-[11px] uppercase tracking-wide text-secondary shadow-lg\`}>\n              <div className=\"flex items-center\">缂栧彿/棰勮</div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>鍓ф湰</span>\n                <Button variant=\"secondary\" size=\"sm\" onClick={batchInferScenes}>鎵归噺鎺ㄧ悊</Button>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>鍒嗛暅鍥炬弿杩拌瘝</span>\n                <Button variant=\"secondary\" size=\"sm\" onClick={batchInferImagePrompts}>鎵归噺鎺ㄧ悊</Button>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>瑙嗛鎻忚堪璇?</span>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>瑙掕壊閫夋嫨</span>\n                <Button variant=\"secondary\" size=\"sm\" onClick={batchInferCharacters}>鎵归噺鎺ㄧ悊</Button>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>褰撳墠鍒嗛暅</span>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>鍒嗛暅閫夋嫨</span>\n                <Button variant=\"secondary\" size=\"sm\" onClick={batchGenerateImages}>鎵归噺鐢熷浘</Button>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>褰撳墠瑙嗛</span>\n              </div>\n              <div className=\"flex items-center justify-between gap-2\">\n                <span>瑙嗛閫夋嫨</span>\n                <Button variant=\"secondary\" size=\"sm\" onClick={batchGenerateVideos}>鎵归噺鐢熸垚</Button>\n              </div>\n              <div className=\"flex items-center justify-center\">\n                <span>鎿嶄綔</span>\n              </div>\n            </div>\n          </div>\n\n          {projectData.items.map((item) => {\n            const scriptSource = item.script ?? item.description;\n            const lines = (item.scriptLines && item.scriptLines.length > 0 ? item.scriptLines : splitChineseSentences(scriptSource));\n            const statusMeta = describeStatus(item.status);\n            const imageStatus = describeStatus((item.imageStatus ?? 'pending') as ProjectItem['status']);\n            const videoStatus = describeStatus((item.videoStatus ?? 'pending') as ProjectItem['status']);\n            return (\n              <div key={item.id} data-row className=\"rounded-2xl border border-app bg-surface/60 px-3 py-3 shadow-lg\">\n                <div className={\`${tableGrid} items-stretch\`}>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col items-center gap-2 shadow-inner\">\n                    <span className=\"text-xl font-mono text-primary\">{String(item.id).padStart(2, '0')}</span>\n                    <Badge variant=\"outline\" className={\`w-full justify-center ${getTypeColor(item.type)}\`}>{item.type === 'scene' ? 'Scene' : 'Transition'}</Badge>\n                    <Badge className={\`w-full justify-center ${statusMeta.className}\`}>{statusMeta.label}</Badge>\n                    <div className=\"w-full space-y-1\">\n                      <Badge className={\`w-full justify-center ${imageStatus.className}\`}>IMG {imageStatus.label}</Badge>\n                      <Badge className={\`w-full justify-center ${videoStatus.className}\`}>VID {videoStatus.label}</Badge>\n                    </div>\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-4 py-3 flex flex-col gap-3 shadow-inner min-h-[220px]\">\n                    <div className=\"flex items-center justify-between gap-2 flex-wrap\">\n                      <p className=\"text-xs text-secondary uppercase tracking-wide\">鍓ф湰鍐呭</p>\n                      <div className=\"flex flex-wrap gap-2\">\n                        <Button variant=\"secondary\" size=\"sm\" onClick={() => {\n                          setProjectData(prev => {\n                            const items = [...prev.items]\n                            const curIdx = items.findIndex(it => it.id === item.id)\n                            if (curIdx<=0) return prev\n                            const cur = items[curIdx]\n                            const prv = items[curIdx-1]\n                            const curLines = (cur.scriptLines && cur.scriptLines.length>0 ? cur.scriptLines : splitChineseSentences(cur.script ?? cur.description))\n                            const prvLines = (prv.scriptLines && prv.scriptLines.length>0 ? prv.scriptLines : splitChineseSentences(prv.script ?? prv.description))\n                            items[curIdx-1] = { ...prv, scriptLines: [...prvLines, ...curLines] }\n                            items.splice(curIdx,1)\n                            items.forEach((it,i)=>{ it.id = i+1 })\n                            const stats = calculateStats(items)\n                            const next = { ...prev, items, ...stats }\n                            scheduleSave(next)\n                            return next\n                          })\n                        }}>骞跺叆涓婁竴琛?</Button>\n                        <Button variant=\"secondary\" size=\"sm\" onClick={() => {\n                          setProjectData(prev => {\n                            const items = [...prev.items]\n                            const curIdx = items.findIndex(it => it.id === item.id)\n                            if (curIdx<0 || curIdx>=items.length-1) return prev\n                            const cur = items[curIdx]\n                            const nxt = items[curIdx+1]\n                            const curLines = (cur.scriptLines && cur.scriptLines.length>0 ? cur.scriptLines : splitChineseSentences(cur.script ?? cur.description))\n                            const nxtLines = (nxt.scriptLines && nxt.scriptLines.length>0 ? nxt.scriptLines : splitChineseSentences(nxt.script ?? nxt.description))\n                            items[curIdx+1] = { ...nxt, scriptLines: [...curLines, ...nxtLines] }\n                            items.splice(curIdx,1)\n                            items.forEach((it,i)=>{ it.id = i+1 })\n                            const stats = calculateStats(items)\n                            const next = { ...prev, items, ...stats }\n                            scheduleSave(next)\n                            return next\n                          })\n                        }}>骞跺叆涓嬩竴琛?</Button>\n                        <Button variant=\"default\" size=\"sm\" onClick={() => {\n                          setProjectData(prev => {\n                            const items = [...prev.items]\n                            const curIdx = items.findIndex(it => it.id === item.id)\n                            const cur = items[curIdx]\n                            const curLines = (cur.scriptLines && cur.scriptLines.length>0 ? cur.scriptLines : splitChineseSentences(cur.script ?? cur.description))\n                            if (curLines.length<=1) return prev\n                            const first = curLines[0]\n                            const rest = curLines.slice(1)\n                            items[curIdx] = { ...cur, scriptLines: [first] }\n                            const inserts = rest.map((ln, i) => ({ ...cur, id: cur.id + i + 1, scriptLines: [ln], script: (cur.script ?? cur.description) }))\n                            items.splice(curIdx+1,0,...inserts)\n                            items.forEach((it,i)=>{ it.id = i+1 })\n                            const stats = calculateStats(items)\n                            const next = { ...prev, items, ...stats }\n                            scheduleSave(next)\n                            return next\n                          })\n                        }}>鎷嗕负澶氬垎闀?</Button>\n                      </div>\n                    </div>\n                    <div className=\"rounded-xl border border-dashed border-app/60 bg-app/40 p-3 space-y-2 overflow-y-auto no-scrollbar\">\n                      <p className=\"text-xs text-primary leading-relaxed whitespace-pre-wrap break-words\">{scriptSource}</p>\n                      <div className=\"space-y-1\">\n                        {lines.map((line, idx) => (\n                          <div key={idx} className=\"rounded-lg bg-surface/60 px-2 py-1 text-xs text-secondary leading-relaxed whitespace-pre-wrap break-words\">\n                            {line}\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-2 shadow-inner\">\n                    <span className=\"text-xs uppercase text-secondary tracking-wide\">鍥惧儚鎻忚堪璇?</span>\n                    <Input value={item.imagePrompt ?? ''} onChange={(e)=>{\n                      const v = e.target.value\n                      setProjectData(prev => ({\n                        ...prev,\n                        items: prev.items.map(it => it.id === item.id ? { ...it, imagePrompt: v } : it)\n                      }))\n                    }} className=\"w-full bg-transparent text-primary border border-app h-[36px]\" placeholder=\"鍥惧儚鎻忚堪璇?\" />\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-2 shadow-inner\">\n                    <span className=\"text-xs uppercase text-secondary tracking-wide\">瑙嗛鎻忚堪璇?</span>\n                    <Input value={item.videoPrompt ?? ''} onChange={(e)=>{\n                      const v = e.target.value\n                      setProjectData(prev => ({\n                        ...prev,\n                        items: prev.items.map(it => it.id === item.id ? { ...it, videoPrompt: v } : it)\n                      }))\n                    }} className=\"w-full bg-transparent text-primary border border-app h-[36px]\" placeholder=\"瑙嗛鎻忚堪璇?\" />\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-3 shadow-inner\">\n                    <span className=\"text-xs uppercase text-secondary tracking-wide\">瑙掕壊璧勬簮</span>\n                    {item.characters && item.characters.length > 0 ? (\n                      <div className=\"flex flex-wrap gap-1\">\n                        {item.characters.map((name, idx) => (\n                          <Badge key={idx} variant=\"outline\" className=\"px-2 py-0.5 text-xs\">{name}</Badge>\n                        ))}\n                      </div>\n                    ) : (\n                      <p className=\"text-xs text-secondary\">鏈～鍏呴闃熺敓鎴愮敤鎴锋暟鎹?</p>\n                    )}\n                    <div className=\"grid grid-cols-2 gap-2\">\n                      {[0,1,2,3].map((i) => (\n                        <div key={i} className=\"w-full bg-black rounded-lg aspect-square\" />\n                      ))}\n                    </div>\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-3 shadow-inner\">\n                    <div className=\"flex items-center justify-between text-xs uppercase text-secondary tracking-wide\">\n                      <span>褰撳墠鍒嗛暅</span>\n                    </div>\n                    <div className=\"rounded-xl bg-black w-full border border-app/50 overflow-hidden\" style={{ aspectRatio: '16 / 9' }}>\n                      {item.currentImage ? (\n                        <img src={item.currentImage} alt=\"褰撳墠鍒嗛暅\" className=\"w-full h-full object-cover\" />\n                      ) : (\n                        <div className=\"w-full h-full flex items-center justify-center text-xs text-secondary\">鏆傛椂鏃犲浘</div>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-2 shadow-inner\">\n                    <div className=\"flex items-center justify-between text-xs uppercase text-secondary tracking-wide\">\n                      <span>鍒嗛暅閫夋嫨</span>\n                    </div>\n                    <ImageThumbList\n                      wrapperClassName=\"flex-1 rounded-xl border border-dashed border-app/60 bg-app/40 p-2\"\n                      setContainerRef={(el) => { listRefs.current[item.id] = el; }}\n                      options={(Array.isArray(item.imageOptions) && item.imageOptions.length > 0 ? item.imageOptions : [null]) as (string | null)[]}\n                      bar={listBars[item.id]}\n                      setBarActive={(active) => {\n                        const b = listBars[item.id];\n                        if (!b) return;\n                        setListBars(prev => ({ ...prev, [item.id]: { ...b, active } }));\n                      }}\n                      onScroll={() => computeListBar(item.id)}\n                      onWheel={(e) => {\n                        smartWheel(listRefs.current[item.id] as HTMLElement | null, e, true);\n                        computeListBar(item.id);\n                      }}\n                      thumbWidth={thumbWByRow[item.id]}\n                      dataKey={item.id}\n                      selected={item.currentImage ?? null}\n                      onSelect={(value) => {\n                        setProjectData(prev => ({\n                          ...prev,\n                          items: prev.items.map(it => it.id === item.id ? { ...it, currentImage: value ?? undefined } : it)\n                        }))\n                      }}\n                    />\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-3 shadow-inner\">\n                    <div className=\"flex items-center justify-between text-xs uppercase text-secondary tracking-wide\">\n                      <span>褰撳墠瑙嗛</span>\n                    </div>\n                    <div\n                      ref={(el) => { currentVideoRefs.current[item.id] = el; }}\n                      className=\"rounded-xl bg-black w-full border border-app/50\"\n                      style={{ aspectRatio: '16 / 9' }}\n                      onDoubleClick={() => { setPreviewTarget({ id: item.id, video: item.currentVideo }); setPreviewOpen(true) }}\n                    />\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col gap-2 shadow-inner\">\n                    <div className=\"flex items-center justify-between text-xs uppercase text-secondary tracking-wide\">\n                      <span>瑙嗛閫夋嫨</span>\n                    </div>\n                    <VideoThumbList\n                      wrapperClassName=\"flex-1 rounded-xl border border-dashed border-app/60 bg-app/40 p-2\"\n                      setContainerRef={(el) => { listRefs.current[item.id] = el; }}\n                      options={(Array.isArray(item.videoOptions) && item.videoOptions.length > 0 ? item.videoOptions : [null]) as (string | null)[]}\n                      bar={listBars[item.id]}\n                      setBarActive={(active) => {\n                        const b = listBars[item.id];\n                        if (!b) return;\n                        setListBars(prev => ({ ...prev, [item.id]: { ...b, active } }));\n                      }}\n                      onScroll={() => computeListBar(item.id)}\n                      onWheel={(e) => {\n                        smartWheel(listRefs.current[item.id] as HTMLElement | null, e, true);\n                        computeListBar(item.id);\n                      }}\n                      thumbWidth={thumbWByRow[item.id]}\n                      dataKey={item.id}\n                      selected={item.currentVideo ?? null}\n                      onSelect={(value) => {\n                        setProjectData(prev => ({\n                          ...prev,\n                          items: prev.items.map(it => it.id === item.id ? { ...it, currentVideo: value ?? undefined } : it)\n                        }))\n                      }}\n                    />\n                  </div>\n                  <div className=\"rounded-2xl border border-app bg-app/70 px-3 py-3 flex flex-col items-center justify-center gap-2 shadow-inner\">\n                    <button\n                      onClick={() => generateVideo(item.id)}\n                      disabled={item.status === 'generating'}\n                      className={\`w-full px-2 py-2 text-xs rounded-md text-center transition-colors ${\n                        item.status === 'generating'\n                          ? 'bg-warning-subtle text-warning cursor-not-allowed'\n                          : item.status === 'generated'\n                          ? 'bg-success-subtle text-success'\n                          : 'bg-surface hover:bg-surface-hover text-primary'\n                      }\`}\n                    >\n                      {item.status === 'generating' ? '鐢熸垚涓?..' : '鐢熸垚瑙嗛'}\n                    </button>\n                    <Button size=\"sm\" variant=\"secondary\" onClick={() => optimizeScene(item.id)} className=\"w-full\">浼樺寲鍒嗛暅</Button>\n                  </div>\n                </div>\n              </div>\n            )\n          })}\n          <div className=\"absolute right-[12px] top-[8px] brand-body-xs nums-tabular text-secondary\">{scrollIndex} / {projectData.items.length || 1}</div>\n        </div>\n      </div>\n"""
path.write_text(text[:start] + new_block + text[end:], encoding='utf-8')
