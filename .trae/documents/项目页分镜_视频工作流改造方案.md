## 目标
- 在项目页增加“序号、剧本、预设、分镜图描述词、视频描述词、当前分镜、可选分镜、当前视频、可选视频、操作”列。
- 支持新建项目时导入剧本，自动拆分为分镜项。
- 批量生成分镜图描述词（AI），基于描述词用 Nanobana 批量生成分镜图；用户从可选分镜中选择设为当前分镜。
- 基于分镜图和视频描述词，调用 Sora2 批量生成视频；用户从可选视频中选择设为当前视频。

## 现状与切入点
- 项目页表格已具备编号/分镜描述/角色选择/当前视频/视频选择/操作等列，渲染在 `src/pages/ProjectInterface.tsx:594-623`。
- 分镜文件导入与拆分逻辑已在项目页实现：`importStoryboardText`（`src/pages/ProjectInterface.tsx:387-403`）。
- 项目数据结构 `ProjectItem` 当前仅包含视频相关字段（`src/store/project.ts:3-11`）。
- 新建项目弹窗未把上传的分镜文件解析为项目项（`src/components/business/NewProjectDialog.tsx:83-106`）。
- AI 封装已具备 Gemini 调用（`src/services/ai/gemini.ts:21-79`），可复用做描述词生成。

## 数据模型扩展
- `ProjectItem` 增加：
  - `script?: string`（原剧本片段）
  - `imagePrompt?: string`，`videoPrompt?: string`
  - `currentImage?: string`，`imageOptions?: string[]`
  - `videoOptions?: string[]`（已存在）、`currentVideo?: string`（已存在）
  - `imageStatus?: 'pending'|'generating'|'generated'`，`videoStatus?: 'pending'|'generating'|'generated'`
- `ProjectData` 顶部统计保持视频为主；后续可按需增加分镜图统计。
  - 计算统计的函数在 `src/pages/ProjectInterface.tsx:52-58`，保留视频统计，必要时新增图像统计。

## 页面改造（ProjectInterface）
- 表头：新增/调整列以匹配目标（在 `src/pages/ProjectInterface.tsx:594-623` 基础上）
  - `剧本`（显示 `item.script`，可点击编辑）
  - `预设`（预留角色/镜头风格选择，下挂“生图设置/项目设置”一致的下拉）
  - `分镜图描述词`（显示/编辑 `item.imagePrompt`，支持“一键重生成”）
  - `视频描述词`（显示/编辑 `item.videoPrompt`）
  - `当前分镜`（渲染 `item.currentImage` 缩略图，双击预览）
  - `可选分镜`（列表组件，点击设为当前分镜）
  - 保留 `当前视频`、`可选视频` 与现有交互（双击预览、点击设为当前）
  - `操作`（行内按钮：生成分镜图、生成视频、优化分镜、清空候选）
- 交互：
  - “批量生成分镜图描述词”“批量生成分镜图”“批量生成视频”置于顶部操作区（现有 `batchGenerateVideos` 同类，扩展两个批量函数）。
  - 选中候选（分镜/视频）立即写入 `currentImage`/`currentVideo` 并触发节流保存（沿用 `scheduleSave`，`src/pages/ProjectInterface.tsx:297-307`）。
- 列表组件：
  - 复用 `VideoThumbList` 的滚动/滚动条计算能力，提炼为通用 `MediaThumbList`，支持 `type="image"|"video"`；图片用 `<img src=...>` 渲染缩略图。

## 新建项目导入剧本
- 在 `NewProjectDialog` 中，解析上传的 `.txt/.md/.csv/.xlsx`（先支持 `.txt/.md`），沿用 `importStoryboardText` 的规则拆分：
  - 识别行前缀 `转场`/`场景`，生成 `items`（见 `src/pages/ProjectInterface.tsx:387-403`）。
  - 将解析得到的 `items` 作为初始项目数据写入 `project:<id>`，并把每行文本同时填入 `script` 字段。
- 为避免重复逻辑，提取公共方法到 `src/utils/storyboard.ts`（`parseStoryboardText`），项目页和新建弹窗共同复用。

## AI 生成与外部服务集成
- 分镜图/视频描述词（Prompt）生成：
  - 新增 `src/prompts/storyboard.ts`：
    - `buildImagePrompt(script: string, context?: {...})`、`buildVideoPrompt(script: string, imagePrompt?: string)`。
  - 在项目页新增 `batchInferImagePrompts`、`batchInferVideoPrompts`：
    - 调用 `sendChat`（`src/services/ai/gemini.ts:21-79`），要求严格 JSON 输出（`{ id: number; imagePrompt: string }[]` 等）。
- Nanobana（生图）：
  - 新增 `src/services/image/nanobana.ts`：`generateImages(prompts: Array<{id:number; text:string}>) => Promise<Record<number,string[]>>`。
  - 返回的 URL 列表写入 `item.imageOptions`，默认取第一个为 `currentImage`（可配置）。
- Sora2（生视频）：
  - 新增 `src/services/video/sora2.ts`：`generateVideos(items: Array<{id:number; videoPrompt:string; image?:string}>) => Promise<Record<number,string[]>>`。
  - 返回的 URL 列表写入 `item.videoOptions`，默认取第一个为 `currentVideo`。
- 设置与密钥：
  - 在 `store/settings.ts` 增加 `nanobana`、`sora2` 的 `keys/base/modelsList` 字段（对齐现有结构），并在“生图设置/项目设置”中提供输入框。

## 任务状态与批量流程
- 每个分镜项的状态拆分：
  - 图像：`imageStatus`；视频：`videoStatus`。
- 顶部统计栏（`src/pages/ProjectInterface.tsx:481-499`）保留视频统计，后续可扩展图像统计。
- 批量流程：
  1. 导入剧本 → 生成 `items`
  2. 批量生成图像描述词 → 写入 `imagePrompt`
  3. 批量生图（Nanobana）→ 写入 `imageOptions`/`currentImage`
  4. 批量生成视频描述词 → 写入 `videoPrompt`
  5. 批量生视频（Sora2）→ 写入 `videoOptions`/`currentVideo`

## 预设（角色设置，预留）
- 在项目页“预设”列展示当前预设摘要；详细配置放到独立板块（后续实现）。
- 结构建议：`src/store/presets.ts`（角色、镜头风格、画幅、光影、场景标签），在项目页选择应用到行项。

## 验证与回退
- 本地持久化沿用 `localStorage`（`src/store/project.ts:68-71`）。
- 预览交互沿用现有弹窗（`src/pages/ProjectInterface.tsx:467-475`）。
- 当外部服务失败时：保留已生成的候选，不影响编辑；错误以 Toast 告知。

## 交付粒度
- 第一步交付：数据结构扩展 + 项目页列改造 + 新建项目导入剧本。
- 第二步交付：AI 生成描述词 + Nanobana 生图集成 + 可选分镜选择交互。
- 第三步交付：Sora2 生视频集成 + 批量流程打通 + 统计与状态完善。

---
若确认该方案，我将按上述顺序在现有文件中增量实现，并尽量复用组件与保存逻辑，避免破坏现有行为。